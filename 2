from docx import Document
from docx.oxml import OxmlElement
from copy import deepcopy

def get_all_tables(doc):
    return [el for el in doc.element.body if el.tag.endswith('tbl')]

def find_table_by_title(doc, title_keyword):
    """
    æ‰¾åˆ°æ®µè½ä¸­åŒ…å«è¡¨æ ¼æ ‡é¢˜çš„æ–‡æœ¬ï¼Œç„¶åè¿”å›åç»­ç¬¬ä¸€ä¸ªè¡¨æ ¼çš„ä½ç½®åŠè¡¨æ ¼å¯¹è±¡
    """
    body = doc.element.body
    found = False
    for i, el in enumerate(body):
        if el.tag.endswith('p'):
            text = ''.join(node.text or '' for node in el.iter() if node.tag.endswith('t'))
            if title_keyword in text:
                found = True
        elif found and el.tag.endswith('tbl'):
            return i, el
    return None, None

def replace_tables_by_title(source_docx, target_docx, title_to_source_index_map, output_path):
    source_doc = Document(source_docx)
    target_doc = Document(target_docx)

    source_tables = get_all_tables(source_doc)
    target_body = target_doc.element.body

    for title_text, source_index in title_to_source_index_map.items():
        if source_index >= len(source_tables):
            print(f"âŒ æºæ–‡æ¡£ä¸­æ²¡æœ‰ç¬¬ {source_index+1} ä¸ªè¡¨æ ¼ï¼Œè·³è¿‡â€œ{title_text}â€")
            continue

        target_index, target_tbl = find_table_by_title(target_doc, title_text)
        if target_tbl is None:
            print(f"âŒ æœªæ‰¾åˆ°ç›®æ ‡æ–‡æ¡£ä¸­æ ‡é¢˜åŒ…å«â€œ{title_text}â€çš„è¡¨æ ¼ï¼Œè·³è¿‡")
            continue

        # æ›¿æ¢è¡¨æ ¼
        new_table = deepcopy(source_tables[source_index])
        target_body.insert(target_body.index(target_tbl), new_table)
        target_body.remove(target_tbl)
        print(f"âœ… æ›¿æ¢å®Œæˆï¼šæ ‡é¢˜â€œ{title_text}â€å¯¹åº”è¡¨æ ¼")

    target_doc.save(output_path)
    print(f"\nğŸ“„ æ‰€æœ‰è¡¨æ ¼æ›¿æ¢å®Œæˆï¼Œä¿å­˜è‡³ï¼š{output_path}")

# âœ… ç¤ºä¾‹è°ƒç”¨
replace_tables_by_title(
    source_docx='source.docx',
    target_docx='target.docx',
    title_to_source_index_map={
        "ç‰©ç†æœºæˆ¿": 0,
        "ç‰©ç†æœºæˆ¿": 0
    },
    output_path='output.docx'
)
